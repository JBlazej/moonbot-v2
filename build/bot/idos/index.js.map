{"version":3,"sources":["../../../src/bot/idos/index.js"],"names":["initializeIdosTable","sendIdosAnswer","from","to","timeTravel","dateTravel","url","result","Promise","resolve","reject","then","html","parseHtml","cheerio","load","decodeEntities","normalizeWhitespace","data","attr","first","parsetable","j","length","parseTable","i","push","console","log","catch","err","sender","text","stops","transformTextForIdos","encodeUrlParameter","initializePromise","async","eachSeries","idosData","callback","Error","pom","splitInformation","extraInformation","split","toString","break","setTimeout","templates","zastavka","prijezd","odjezd","spoj","charAt","toLowerCase","val","isEven","message","message2","value","onlyConnections","replace","encodeURIComponent"],"mappings":"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","file":"index.js","sourcesContent":["import request from 'request-promise'\nimport async from 'async'\nimport cheerio from 'cheerio'\nimport cheerioTableparser from 'cheerio-tableparser'\nimport {sendTextMessage, sendGenMessage} from '../lib/messages'\nimport {templates} from '../../views/templates'\n\nexport function initializeIdosTable(from, to, timeTravel, dateTravel){\n    let url = `https://jizdnirady.idnes.cz/praha/spojeni/?f=${from}&t=${to}&time=${timeTravel}&date=${dateTravel}&submit=true`\n    let result = []\n  \n    return new Promise( (resolve, reject) => {\n      request(url).then((html) => {\n        const parseHtml = cheerio.load(html, { decodeEntities: false, normalizeWhitespace: true })\n        cheerioTableparser(parseHtml)\n  \n        // Parse data from Idos\n        const data = parseHtml('table tbody').attr('class', 'results').first().parsetable(true, true, true)\n        // 6 columns in 1 row\n\n        for ( var j = 0; j < data[2].length; j++ ){\n          const parseTable = []\n  \n          for( var i = 2; i < data.length ; i++ ){\n            parseTable.push(data[i][j])\n          }\n  \n          result.push(parseTable)\n        }\n        resolve(result)\n        console.log(result)\n      }).catch((err) => reject(err))\n    })\n  }\n\n  //initializeIdosTable('husinecka', 'volha', '10:30', '22.11.2018')\n\n export function sendIdosAnswer(sender, text, timeTravel, dateTravel) {\n   const stops = transformTextForIdos(text)\n   \n   let from = encodeUrlParameter(stops[0])\n   let to = encodeUrlParameter(stops[1])\n   \n   const initializePromise = initializeIdosTable(from, to, timeTravel, dateTravel)\n    initializePromise.then( (result) => {\n        // Initialized table data\n        const data = result\n  \n        let i = 0\n  \n        async.eachSeries(data, function(idosData, callback) {\n  \n          if (i === data.length - 1) {\n          // Break out of async\n          var err = new Error('Broke out of async')\n          const pom = data.length\n          const splitInformation = []\n          splitInformation.push(data[pom-1])\n  \n          let extraInformation = splitInformation[0][0].split(\",\",3).toString()\n          extraInformation += \" Kč\"\n  \n          err.break = true\n  \n          setTimeout(()=>{sendTextMessage(sender, extraInformation)}, 500)\n          setTimeout(()=>{sendGenMessage(sender, templates['get_test'])}, 700)\n          return callback(err)\n          }\n  \n          setTimeout(() => {\n            let zastavka = idosData[0]\n            let prijezd = idosData[1]\n            let odjezd  = idosData[2]\n            let spoj = idosData[5]\n  \n  \n            if (odjezd.length === 0 || odjezd.length === 1){ odjezd = 'příjezd'; }\n            if (prijezd.length === 0 || prijezd.length === 1){ prijezd = 'odjezd'; }\n            if (spoj.length === 3){\n  \n               spoj = ', autobusem č. ' + spoj\n  \n  \n             }\n  \n             if (spoj === 'A' || spoj === 'B' || spoj === 'C'){\n               spoj = ', metro ' + spoj\n  \n             }\n  \n             if(spoj.length === 2 || spoj.length === 1){\n               spoj = ', tramvají č. ' + spoj\n  \n  \n             }\n  \n             if(spoj.charAt(0) === 'P'){\n               spoj = ', ' + spoj.toLowerCase()\n             }\n  \n            let val = isEven(i);\n  \n            if (val === false){\n              let message = zastavka + ' ' + odjezd + ' ' + prijezd + spoj \n              sendTextMessage(sender, message)\n              //console.log(message)\n  \n            } else {\n              let message2 = zastavka + ' ' + prijezd + ' ' + odjezd + spoj \n              sendTextMessage(sender, message2)\n              //console.log(message2)\n            }\n  \n  \n            i++\n  \n            callback()\n          }, 800)\n        })\n      }, (err) => {\n        sendTextMessage(sender, \"Něco se pokazilo zkus to znovu :-(\")\n    })\n  }\n  \n  function isEven(value) {\n      if (value%2 == 0)\n          return true;\n      else\n          return false;\n  }\n\n  function transformTextForIdos(text){\n    const onlyConnections = text.replace(\"spoj \", \"\")\n    const stops = onlyConnections.split(\" do \")\n\n    return stops\n  }\n\n\nfunction encodeUrlParameter(value) {\n\treturn encodeURIComponent(value)\n  \t.replace(/\\%20/g, '+')\n}"]}